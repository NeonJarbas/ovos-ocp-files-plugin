import pytest

from audio_metadata import (
	FLAC,
	FLACApplication,
	FLACCueSheet,
	FLACCueSheetIndex,
	FLACCueSheetTrack,
	FLACMetadataBlock,
	FLACPadding,
	FLACPicture,
	FLACSeekPoint,
	FLACSeekTable,
	ID3PictureType,
	InvalidBlock,
	InvalidHeader,
)


def test_FLAC_load_ID3v2():
	FLAC.load(
		b'ID3\x04\x00\x80\x00\x00\x00\x00'
		b'fLaC\x80\x00\x00"\x10\x00\x10\x00\x00\x00\x0e\x00\x00\x10\n'
		b'\xc4B\xf0\x00\x03]T\x9b\x1b\xe8|kW\x9f\xde#AQ_M\x82\xc0\x08'
	)


def test_FLAC_load_padding():
	FLAC.load(
		b'fLaC\x00\x00\x00"\x10\x00\x10\x00\x00\x00\x0e\x00\x00\x10\n'
		b'\xc4B\xf0\x00\x03]T\x9b\x1b\xe8|kW\x9f\xde#AQ_M\x82\xc0\x08'
		b'\x81\x00\x00\n'
	)


def test_FLAC_load_application():
	FLAC.load(
		b'fLaC\x00\x00\x00"\x10\x00\x10\x00\x00\x00\x0e\x00\x00\x10\n'
		b'\xc4B\xf0\x00\x03]T\x9b\x1b\xe8|kW\x9f\xde#AQ_M\x82\xc0\x08'
		b'\x82\x00\x00\x10aiffFORM\x02\xe0\x9b\x08AIFF'
	)


def test_FLAC_load_seektable():
	FLAC.load(
		b'fLaC\x00\x00\x00"\x10\x00\x10\x00\x00\x00\x0e\x00\x00\x10\n'
		b'\xc4B\xf0\x00\x03]T\x9b\x1b\xe8|kW\x9f\xde#AQ_M\x82\xc0\x08'
		b'\x83\x00\x00Z\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00'
		b'\x00\x00\x00\x00\x00\x00\xa0\x00\x00\x00\x00\x00\x00\x00\x00\x8c\x10\x00'
		b'\x00\x00\x00\x00\x00\x01P\x00\x00\x00\x00\x00\x00\x00\x01&\x10\x00'
		b'\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x01\xc0\x10\x00'
		b'\x00\x00\x00\x00\x00\x02\xb0\x00\x00\x00\x00\x00\x00\x00\x02Z\x10\x00'
	)


def test_FLAC_load_vorbis_comment():
	FLAC.load(
		b'fLaC\x00\x00\x00"\x10\x00\x10\x00\x00\x00\x0e\x00\x00\x10\n'
		b'\xc4B\xf0\x00\x03]T\x9b\x1b\xe8|kW\x9f\xde#AQ_M\x82\xc0\x08'
		b'\x84\x00\x00\x15\r\x00\x00\x00Lavf58.30.100\x00\x00\x00\x00'
	)


def test_FLAC_load_cuesheet():
	FLAC.load(
		b'fLaC\x00\x00\x00"\x10\x00\x10\x00\x00\x00\x0e\x00\x00\x10\n'
		b'\xc4B\xf0\x00\x03]T\x9b\x1b\xe8|kW\x9f\xde#AQ_M\x82\xc0\x08'
		b'\x85\x00\x02L1234567890123\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01X\x88\x80\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x01123456789012\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\xacD\x02\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x02L\x02\x00\x00\x00\x00\x00\x00\x00\x00\x01X\x88\x03\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x02z\xc0\xaa\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
	)


def test_FLAC_load_picture():
	FLAC.load(
		b'fLaC\x00\x00\x00"\x10\x00\x10\x00\x00\x00\x0e\x00\x00\x10\n'
		b'\xc4B\xf0\x00\x03]T\x9b\x1b\xe8|kW\x9f\xde#AQ_M\x82\xc0\x08'
		b'\x86\x00\x00\x89\x00\x00\x00\x03\x00\x00\x00\timage/png\x00\x00\x00\x00'
		b'\x00\x00\x00\x10\x00\x00\x00\x10\x00\x00\x00 \x00\x00\x00\x00\x00\x00\x00'
		b'`\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x10\x00\x00\x00\x10\x08'
		b'\x06\x00\x00\x00\x1f\xf3\xffa\x00\x00\x00\tpHYs\x00\x00\x0b\x12\x00\x00\x0b'
		b'\x12\x01\xd2\xdd~\xfc\x00\x00\x00\x12IDAT8\xcbc`\x18\x05\xa3`\x14\x8c\x02'
		b'\x08\x00\x00\x04\x10\x00\x01\x85?\xaar\x00\x00\x00\x00IEND\xaeB`\x82'
	)


def test_FLAC_load_reserved_block_type():
	flac = FLAC.load(
		b'fLaC\n\x00\x00\x00\x80\x00\x00"\x10\x00\x10\x00\x00\x00\x0e\x00\x00\x10\n'
		b'\xc4B\xf0\x00\x03]T\x9b\x1b\xe8|kW\x9f\xde#AQ_M\x82\xc0\x08'
	)

	assert flac._blocks[0] == FLACMetadataBlock(
		type=10,
		data=b'',
	)


def test_FLAC_load_no_duration():
	FLAC.load(
		b'fLaC\x80\x00\x00"\x12\x00\x12\x00\x00\x00\x00\x00JX\n\xc4B\xf0\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
	)


def test_FLAC_invalid_header():
	with pytest.raises(InvalidHeader, match="Valid FLAC header not found"):
		FLAC.load(b'TEST')


def test_FLAC_invalid_block_type():
	with pytest.raises(InvalidBlock, match="127 is not a valid FLAC metadata block type"):
		FLAC.load(b'fLaC\xff\x00\x00\x00')


def test_FLACApplication():
	application_init = FLACApplication(
		id='aiff',
		data=b'FORM\x02\xe0\x9b\x08AIFF'
	)
	application_load = FLACApplication.load(
		b'aiffFORM\x02\xe0\x9b\x08AIFF'
	)

	assert application_init == application_load
	assert application_init.id == application_load.id == 'aiff'
	assert application_init.data == application_load.data == b'FORM\x02\xe0\x9b\x08AIFF'
	assert repr(application_init) == repr(application_load) == '<FLACApplication (aiff)>'


def test_FLACCueSheetIndex():
	cuesheet_index_init = FLACCueSheetIndex(
		number=1,
		offset=0,
	)
	cuesheet_index_load = FLACCueSheetIndex.load(
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00'
	)

	assert cuesheet_index_init == cuesheet_index_load
	assert cuesheet_index_init.number == cuesheet_index_load.number == 1
	assert cuesheet_index_init.offset == cuesheet_index_load.offset == 0
	assert repr(cuesheet_index_init) == repr(cuesheet_index_load) == "<FLACCueSheetIndex ({'number': 1, 'offset': 0})>"

	cuesheet_index_init = FLACCueSheetIndex(
		number=2,
		offset=588,
	)
	cuesheet_index_load = FLACCueSheetIndex.load(
		b'\x00\x00\x00\x00\x00\x00\x02L\x02\x00\x00\x00'
	)

	assert cuesheet_index_init == cuesheet_index_load
	assert cuesheet_index_init.number == cuesheet_index_load.number == 2
	assert cuesheet_index_init.offset == cuesheet_index_load.offset == 588
	assert repr(cuesheet_index_init) == repr(cuesheet_index_load) == "<FLACCueSheetIndex ({'number': 2, 'offset': 588})>"


def test_FLACCueSheetTrack():
	cuesheet_track_init = FLACCueSheetTrack(
		track_number=1,
		offset=0,
		isrc='123456789012',
		type=0,
		pre_emphasis=False,
		indexes=[
			FLACCueSheetIndex(
				number=1,
				offset=0,
			)
		]
	)
	cuesheet_track_load = FLACCueSheetTrack.load(
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x01123456789012'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00'
	)

	assert cuesheet_track_init == cuesheet_track_load
	assert cuesheet_track_init.track_number == cuesheet_track_load.track_number == 1
	assert cuesheet_track_init.offset == cuesheet_track_load.offset == 0
	assert cuesheet_track_init.isrc == cuesheet_track_load.isrc == '123456789012'
	assert cuesheet_track_init.type == cuesheet_track_load.type == 0
	assert cuesheet_track_init.pre_emphasis is False
	assert cuesheet_track_load.pre_emphasis is False

	cuesheet_track_init = FLACCueSheetTrack(
		track_number=2,
		offset=44100,
		isrc='',
		type=1,
		pre_emphasis=True,
		indexes=[
			FLACCueSheetIndex(
				number=1,
				offset=0,
			),
			FLACCueSheetIndex(
				number=2,
				offset=588,
			),
		],
	)
	cuesheet_track_load = FLACCueSheetTrack.load(
		b'\x00\x00\x00\x00\x00\x00\xacD\x02\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x01'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02L\x02\x00\x00\x00'
	)

	assert cuesheet_track_init == cuesheet_track_load
	assert cuesheet_track_init.track_number == cuesheet_track_load.track_number == 2
	assert cuesheet_track_init.offset == cuesheet_track_load.offset == 44100
	assert cuesheet_track_init.isrc == cuesheet_track_load.isrc == ''
	assert cuesheet_track_init.type == cuesheet_track_load.type == 1
	assert cuesheet_track_init.pre_emphasis is True
	assert cuesheet_track_load.pre_emphasis is True


def test_FLACCueSheet():
	cuesheet_init = FLACCueSheet(
		[
			FLACCueSheetTrack(
				track_number=1,
				offset=0,
				isrc='123456789012',
				type=0,
				pre_emphasis=False,
				indexes=[
					FLACCueSheetIndex(
						number=1,
						offset=0,
					)
				]
			),
			FLACCueSheetTrack(
				track_number=2,
				offset=44100,
				isrc='',
				type=1,
				pre_emphasis=True,
				indexes=[
					FLACCueSheetIndex(
						number=1,
						offset=0,
					),
					FLACCueSheetIndex(
						number=2,
						offset=588,
					),
				],
			),
			FLACCueSheetTrack(
				track_number=3,
				offset=88200,
				isrc='',
				type=0,
				pre_emphasis=False,
				indexes=[
					FLACCueSheetIndex(
						number=1,
						offset=0,
					)
				],
			),
			FLACCueSheetTrack(
				track_number=170,
				offset=162496,
				isrc='',
				type=0,
				pre_emphasis=False,
				indexes=[]
			)
		],
		catalog_number='1234567890123',
		lead_in_samples=88200,
		compact_disc=True
	)
	cuesheet_load = FLACCueSheet.load(
		b'1234567890123\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01X\x88\x80\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x01123456789012\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\xacD\x02\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x02L\x02\x00\x00\x00\x00\x00\x00\x00\x00\x01X\x88\x03\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x02z\xc0\xaa\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'
	)

	assert cuesheet_init == cuesheet_load
	assert repr(cuesheet_init) == repr(cuesheet_load) == '<FLACCueSheet (4 tracks)>'


def test_FLACMetadataBlock():
	metadata_block = FLACMetadataBlock(
		type=100,
		data=b'\x00' * 10
	)

	assert metadata_block.type == 100
	assert metadata_block.data == b'\x00' * 10
	assert repr(metadata_block) == '<FLACMetadataBlock [100] (10 bytes)>'


def test_FLACPadding():
	padding_init = FLACPadding(size=10)
	padding_load = FLACPadding.load(b'\x00' * 10)

	assert padding_init == padding_load
	assert repr(padding_init) == repr(padding_load) == '<FLACPadding (10 bytes)>'


def test_FLACPicture():
	image_data = (
		b'\x00\x00\x00\x03\x00\x00\x00\timage/png\x00\x00\x00\x00'
		b'\x00\x00\x00\x10\x00\x00\x00\x10\x00\x00\x00 \x00\x00'
		b'\x00\x00\x00\x00\x00`\x89PNG\r\n\x1a\n\x00\x00\x00\r'
		b'IHDR\x00\x00\x00\x10\x00\x00\x00\x10\x08\x06\x00\x00'
		b'\x00\x1f\xf3\xffa\x00\x00\x00\tpHYs\x00\x00\x0b\x12\x00'
		b'\x00\x0b\x12\x01\xd2\xdd~\xfc\x00\x00\x00\x12IDAT8\xcbc`'
		b'\x18\x05\xa3`\x14\x8c\x02\x08\x00\x00\x04\x10\x00\x01\x85'
		b'?\xaar\x00\x00\x00\x00IEND\xaeB`\x82'
	)

	vorbis_picture_init = FLACPicture(
		type=ID3PictureType.COVER_FRONT,
		mime_type='image/png',
		description='',
		width=16,
		height=16,
		depth=32,
		colors=0,
		data=image_data[41:],
	)
	vorbis_picture_load = FLACPicture.load(image_data)

	assert vorbis_picture_init == vorbis_picture_load


def test_FLACSeektable():
	seekpoints = [
		FLACSeekPoint(
			first_sample=first_sample,
			offset=offset,
			num_samples=num_samples)
		for first_sample, offset, num_samples in [
			(0, 0, 4096),
			(40960, 140, 4096),
			(86016, 294, 4096),
			(131072, 448, 4096),
			(176128, 602, 4096)
		]
	]

	seektable_init = FLACSeekTable(seekpoints)
	seektable_load = FLACSeekTable.load(
		b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00'
		b'\x00\x00\x00\x00\x00\x00\xa0\x00\x00\x00\x00\x00\x00\x00\x00\x8c\x10\x00'
		b'\x00\x00\x00\x00\x00\x01P\x00\x00\x00\x00\x00\x00\x00\x01&\x10\x00'
		b'\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x01\xc0\x10\x00'
		b'\x00\x00\x00\x00\x00\x02\xb0\x00\x00\x00\x00\x00\x00\x00\x02Z\x10\x00'
	)

	assert seektable_init == seektable_load
	assert seektable_init.data == seektable_load.data == seekpoints
